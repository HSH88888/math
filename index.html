<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Master V24 - Bug Fixed</title>
    <style>
        /* [ÌÖåÎßà: Deep Purple & Cyan] */
        :root {
            --bg-color: #2b2742; 
            --card-bg: #1e1b33;
            --accent-cyan: #00f2fe; 
            --accent-purple: #5e5ce6;
            --text-white: #ffffff;
            --text-gray: #a0a0b0;
            --input-bg: rgba(255, 255, 255, 0.1);
            --border-radius: 16px;
            --font-main: 'Segoe UI', Roboto, sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-white);
            height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            user-select: none;
        }

        .app-container {
            width: 100%;
            max-width: 480px;
            height: 100%;
            max-height: 900px;
            background: linear-gradient(180deg, #363255 0%, #1e1b33 100%);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            padding: 25px;
            position: relative;
            overflow-y: auto;
        }
        .app-container::-webkit-scrollbar { display: none; }

        /* [ÏãúÏûë ÌôîÎ©¥] */
        .title-area { text-align: center; margin-top: 30px; margin-bottom: 30px; }
        .main-title { 
            font-size: 3rem; font-weight: 900; color: white; 
            text-shadow: 0 0 20px rgba(0, 242, 254, 0.8);
            margin: 0; 
        }
        .sub-title { color: var(--text-gray); margin-top: 5px; font-size: 1rem; }

        .user-bar { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .user-name { font-weight: bold; color: var(--accent-cyan); font-size: 1.1rem; }
        .btn-change { background: transparent; border: 1px solid var(--accent-cyan); color: var(--accent-cyan); border-radius: 20px; padding: 5px 15px; font-size: 0.8rem; cursor: pointer; }

        .mode-box { background: rgba(0,0,0,0.25); border-radius: 16px; padding: 20px; margin-bottom: 20px; }
        .box-title { color: var(--accent-cyan); font-weight: 800; margin-bottom: 15px; font-size: 1rem; letter-spacing: 1px; text-transform: uppercase; }
        
        .radio-option { display: flex; align-items: flex-start; margin-bottom: 15px; cursor: pointer; }
        .radio-option input { margin-top: 5px; margin-right: 15px; accent-color: var(--accent-cyan); transform: scale(1.3); }
        .opt-title { font-size: 1.1rem; font-weight: bold; color: white; margin-bottom: 4px; }
        .opt-desc { font-size: 0.9rem; color: var(--text-gray); line-height: 1.4; }

        /* Ïó∞ÏÇ∞ Î≤ÑÌäº */
        .op-select { margin-left: 35px; margin-bottom: 10px; display: flex; gap: 8px; }
        .op-btn { 
            width: 40px; height: 40px; 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
            color: white; border-radius: 8px; font-size: 1.2rem; font-weight: bold; cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
        }
        .op-btn.selected { background: var(--accent-cyan); color: #000; border-color: var(--accent-cyan); }

        /* ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù */
        .level-select { margin-left: 35px; margin-bottom: 20px; display: flex; gap: 8px; }
        .lvl-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 5px 12px; border-radius: 8px; font-size: 0.85rem; cursor: pointer; }
        .lvl-btn.selected { background: var(--accent-purple); color: white; border-color: var(--accent-purple); font-weight: bold; }

        .btn-start { width: 100%; padding: 18px; border-radius: 30px; background: var(--accent-cyan); color: #000; font-size: 1.3rem; font-weight: 900; border: none; cursor: pointer; box-shadow: 0 0 20px rgba(0, 242, 254, 0.4); margin-top: 20px; margin-bottom: 10px; }

        /* [Í≤åÏûÑ ÌôîÎ©¥] */
        .game-header { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; margin-bottom: 20px; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .btn-home { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; padding: 0; margin-right: 5px; }
        .q-count { color: white; font-weight: bold; font-size: 1.2rem; }
        .timer { color: var(--accent-cyan); font-weight: bold; font-size: 1.5rem; font-family: monospace; }

        /* Î¨∏Ï†ú Ïπ¥Îìú */
        .problem-card { 
            background: #231f38; border-radius: 20px; padding: 20px; min-height: 180px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 15px; position: relative; 
        }
        .speed-text { font-size: 3.5rem; font-weight: bold; margin-bottom: 5px; line-height: 1; }
        .speed-op { color: #ff3b30; margin: 0 15px; }

        .speed-input-area { width: 100%; display: flex; justify-content: center; margin-top: 10px; } 

        .step-container { background: rgba(255,255,255,0.05); border-radius: 20px; padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 10px; }
        .step-row { display: flex; align-items: center; gap: 10px; font-size: 1.1rem; color: #ccc; }
        .step-input { width: 80px; height: 40px; background: rgba(255,255,255,0.1); border: 2px solid #555; border-radius: 10px; text-align: center; color: white; font-size: 1.2rem; font-weight: bold; outline: none; }
        .step-input.active { border-color: var(--accent-cyan); box-shadow: 0 0 10px rgba(0, 242, 254, 0.3); }

        .v-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0; width: 100%; max-width: 300px; }
        .v-cell { height: 50px; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; font-weight: bold; color: white; }
        .v-line { grid-column: 1/-1; height: 2px; background: #666; margin: 5px 0; }
        .carry-circle { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #666; color: #ff3b30; display:flex; align-items:center; justify-content:center; font-size:1rem; margin:auto;}

        .final-cell-wrapper { padding: 4px; }
        .final-input { width: 100%; height: 55px; background: rgba(255,255,255,0.1); border: 2px solid #555; border-radius: 12px; color: white; text-align: center; font-size: 1.8rem; font-weight: bold; }
        .final-input.active { border-color: var(--accent-cyan); }

        /* ÌÇ§Ìå®Îìú (ÏùºÏûêÌòï) */
        .numpad { display: flex; gap: 5px; margin-top: 20px; width: 100%; margin-bottom: 20px; }
        .key { flex: 1; height: 55px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px; color: white; font-size: 1.4rem; font-weight: bold; cursor: pointer; }
        .key:active { background: rgba(255,255,255,0.3); }
        .key-ent { flex: 1.5; background: var(--accent-cyan); color: #000; }
        .key-del { flex: 1.2; color: #ff3b30; }

        /* Ï†ïÎãµ Î©îÏãúÏßÄ ÏòÅÏó≠ */
        .msg-box { height: 30px; text-align: center; font-size: 2rem; font-weight: bold; margin-bottom: 10px; min-height: 40px;}

        /* Í≤∞Í≥º ÌôîÎ©¥ */
        .result-screen { display: none; text-align: center; }
        .score-big { font-size: 4rem; color: var(--accent-cyan); font-weight: bold; margin: 20px 0; text-shadow: 0 0 20px var(--accent-cyan); }
        .res-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; text-align: left; }
        .res-table th { color: #888; padding: 10px; border-bottom: 1px solid #444; }
        .res-table td { padding: 10px; border-bottom: 1px solid #333; }
        .wrong-ans { color: #ff3b30; font-weight: bold; text-decoration: line-through; margin-right: 5px; }
        .correct-ans { color: var(--accent-cyan); font-weight: bold; }

        .hidden { display: none !important; }
        .modal { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:100; }
        .modal-box { background: #2b2742; padding: 20px; border-radius: 16px; width: 80%; }
        
        .user-list { margin: 15px 0; max-height: 200px; overflow-y: auto; }
        .user-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent;
        }
        .user-item.active { border-color: var(--accent-cyan); background: rgba(0, 242, 254, 0.1); }
        .user-item:active { transform: scale(0.98); }
        .del-user-btn { color: #ff3b30; padding: 5px 10px; border: none; background: transparent; font-size: 1.2rem; cursor: pointer; }

        .new-user-form { display: flex; gap: 8px; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        .modal-input { flex: 1; padding: 12px; border-radius: 10px; border: none; background: rgba(255,255,255,0.1); color: white; font-size: 1rem; }
        .modal-btn { padding: 0 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .btn-add { background: var(--accent-cyan); color: black; }
        .btn-close { width: 100%; padding: 12px; background: #444; color: white; border:none; border-radius:10px; margin-top:10px; font-weight:bold; cursor:pointer;}
    </style>
</head>
<body>

    <div class="app-container" id="screen-start">
        <div class="title-area">
            <h1 class="main-title">MATH V24</h1>
            <div class="sub-title">Ultimate Bug Fixed</div>
        </div>

        <div class="user-bar">
            <span class="user-name" id="display-user">Guest Player</span>
            <button class="btn-change" onclick="openUserModal()">ÏÇ¨Ïö©Ïûê Î≥ÄÍ≤Ω</button>
        </div>

        <div class="mode-box">
            <div class="box-title">TRAINING MODE</div>
            
            <label class="radio-option">
                <input type="radio" name="mode" value="speed" checked onclick="toggleOptions('speed')">
                <div>
                    <div class="opt-title">‚ö° Ïä§ÌîºÎìú Î™®Îìú (Îπ†Î•∏ Ïó∞ÏÇ∞)</div>
                    <div class="opt-desc">ÏõêÌïòÎäî Ïó∞ÏÇ∞ÏùÑ ÏÑ†ÌÉùÌïòÏó¨ Îπ†Î•¥Í≤å ÌíâÎãàÎã§.</div>
                </div>
            </label>
            
            <div id="speed-ops" class="op-select">
                <div class="op-btn" onclick="setOpType('+')" id="op-plus">Ôºã</div>
                <div class="op-btn" onclick="setOpType('-')" id="op-minus">Ôºç</div>
                <div class="op-btn" onclick="setOpType('*')" id="op-mul">√ó</div>
                <div class="op-btn" onclick="setOpType('/')" id="op-div">√∑</div>
                <div class="op-btn selected" onclick="setOpType('random')" id="op-rand">?</div>
            </div>

            <div id="speed-levels" class="level-select">
                <div class="lvl-btn" onclick="setLevel(1)" id="lv1">Lv.1</div>
                <div class="lvl-btn selected" onclick="setLevel(2)" id="lv2">Lv.2</div>
                <div class="lvl-btn" onclick="setLevel(3)" id="lv3">Lv.3</div>
                <div class="lvl-btn" onclick="setLevel(4)" id="lv4">Lv.4</div>
            </div>

            <label class="radio-option">
                <input type="radio" name="mode" value="step" onclick="toggleOptions('step')">
                <div>
                    <div class="opt-title">üê¢ Í≥±ÏÖà Îã®Í≥ÑÎ≥Ñ ÌíÄÏù¥</div>
                    <div class="opt-desc">ÏÑ∏Î°úÏãù Í≥±ÏÖàÏùò ÏõêÎ¶¨Î•º Îã®Í≥ÑÎ≥ÑÎ°ú ÏùµÌûôÎãàÎã§.</div>
                </div>
            </label>
        </div>

        <button class="btn-start" onclick="startGame()">MISSION START</button>
    </div>

    <div class="app-container hidden" id="screen-game">
        <div class="game-header">
            <div class="header-left">
                <button class="btn-home" onclick="goHome()">üè†</button>
                <div class="q-count">Q <span id="q-curr">1</span> / 10</div>
            </div>
            <div class="timer" id="timer">0.0</div>
        </div>

        <div class="problem-card">
            <div id="problem-area" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
            <div id="speed-input-container" class="speed-input-area hidden"></div>
        </div>

        <div id="bottom-area"></div>

        <div id="msg-box" class="msg-box"></div>

        <div class="numpad">
            <button class="key" onclick="inputKey(1)">1</button>
            <button class="key" onclick="inputKey(2)">2</button>
            <button class="key" onclick="inputKey(3)">3</button>
            <button class="key" onclick="inputKey(4)">4</button>
            <button class="key" onclick="inputKey(5)">5</button>
            <button class="key" onclick="inputKey(6)">6</button>
            <button class="key" onclick="inputKey(7)">7</button>
            <button class="key" onclick="inputKey(8)">8</button>
            <button class="key" onclick="inputKey(9)">9</button>
            <button class="key" onclick="inputKey(0)">0</button>
            <button class="key key-del" onclick="delKey()">C</button>
            <button class="key key-ent" onclick="submitAns()">OK</button>
        </div>
    </div>

    <div class="app-container hidden" id="screen-result">
        <div class="title-area">
            <h1 class="main-title" style="font-size:2.5rem;">REPORT</h1>
        </div>
        <div class="score-big" id="final-score">100</div>
        <div style="flex:1; overflow-y:auto; background:rgba(0,0,0,0.2); border-radius:12px; padding:10px;">
            <table class="res-table">
                <thead><tr><th width="10%">No</th><th width="30%">Î¨∏Ï†ú</th><th width="30%">ÎÇ¥Îãµ / Ï†ïÎãµ</th><th width="15%">ÏãúÍ∞Ñ</th><th width="15%">Í≤∞Í≥º</th></tr></thead>
                <tbody id="res-tbody"></tbody>
            </table>
        </div>
        <div style="text-align:center; margin:15px; color:#aaa;">
            Total: <span style="color:#fff" id="total-games">0</span> | Avg: <span style="color:#00f2fe" id="avg-time">0</span>s
        </div>
        <button class="btn-start" onclick="location.reload()">RETRY</button>
    </div>

    <div id="modal-login" class="modal hidden">
        <div class="modal-box">
            <h3 style="color:var(--accent-cyan); margin-bottom:15px;">ÏÇ¨Ïö©Ïûê ÏÑ†ÌÉù</h3>
            <div id="user-list" class="user-list"></div>
            <div class="new-user-form">
                <input type="text" id="inp-name" class="modal-input" placeholder="ÏÉà ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ">
                <button onclick="registerNewUser()" class="modal-btn btn-add">Ï∂îÍ∞Ä</button>
            </div>
            <button onclick="closeUserModal()" class="btn-close">Îã´Í∏∞</button>
        </div>
    </div>

    <script>
        // Îç∞Ïù¥ÌÑ∞
        let mode = 'speed'; 
        let difficulty = 2; 
        let speedOpType = 'random'; 
        let qNum = 1;
        const totalQ = 10;
        let num1, num2, op, ans;
        let activeId = null;
        let history = [];
        let startTime, timerInt;
        let currentUser = null;
        let isProcessing = false;

        // UI Ï†úÏñ¥
        function toggleOptions(m) { 
            mode = m; 
            document.getElementById('speed-levels').style.display = (m === 'speed') ? 'flex' : 'none'; 
            document.getElementById('speed-ops').style.display = (m === 'speed') ? 'flex' : 'none'; 
        }
        function setLevel(lv) { 
            difficulty = lv; 
            document.querySelectorAll('.lvl-btn').forEach(b => b.classList.remove('selected')); 
            document.getElementById('lv' + lv).classList.add('selected'); 
        }
        function setOpType(type) {
            speedOpType = type;
            document.querySelectorAll('.op-btn').forEach(b => b.classList.remove('selected'));
            let btnId = type === '+' ? 'op-plus' : (type === '-' ? 'op-minus' : (type === '*' ? 'op-mul' : (type === '/' ? 'op-div' : 'op-rand')));
            document.getElementById(btnId).classList.add('selected');
        }

        // ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨
        function openUserModal() { renderUserList(); document.getElementById('modal-login').classList.remove('hidden'); }
        function closeUserModal() { document.getElementById('modal-login').classList.add('hidden'); }

        function renderUserList() {
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            const db = JSON.parse(localStorage.getItem('mm_v24_db') || '{}');
            const names = Object.keys(db);

            const guestDiv = document.createElement('div');
            guestDiv.className = `user-item ${currentUser === null ? 'active' : ''}`;
            guestDiv.innerHTML = `<span style="font-weight:bold;">Guest Player</span>`;
            guestDiv.onclick = () => selectUser(null);
            list.appendChild(guestDiv);

            names.forEach(name => {
                const div = document.createElement('div');
                div.className = `user-item ${currentUser && currentUser.name === name ? 'active' : ''}`;
                const userData = db[name];
                const avgTime = userData.games > 0 ? (userData.time / userData.games / 10).toFixed(1) : '0.0';
                div.innerHTML = `<span>${name} <span style="font-size:0.8rem; color:#aaa;">(${userData.games}Ìåê | ${avgTime}s)</span></span><button class="del-user-btn" onclick="deleteUser('${name}', event)">√ó</button>`;
                div.onclick = (e) => { if(e.target.tagName === 'BUTTON') return; selectUser(name); };
                list.appendChild(div);
            });
        }

        function registerNewUser() {
            const nm = document.getElementById('inp-name').value.trim();
            if(!nm) return;
            let db = JSON.parse(localStorage.getItem('mm_v24_db') || '{}');
            if(db[nm]) { alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Ïù¥Î¶ÑÏûÖÎãàÎã§.'); return; }
            db[nm] = { games: 0, time: 0 };
            localStorage.setItem('mm_v24_db', JSON.stringify(db));
            document.getElementById('inp-name').value = '';
            renderUserList();
        }

        function deleteUser(name, e) {
            e.stopPropagation();
            if(!confirm(`'${name}' ÏÇ¨Ïö©ÏûêÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;
            let db = JSON.parse(localStorage.getItem('mm_v24_db') || '{}');
            delete db[name];
            localStorage.setItem('mm_v24_db', JSON.stringify(db));
            if(currentUser && currentUser.name === name) selectUser(null);
            renderUserList();
        }

        function selectUser(name) {
            if(name === null) {
                currentUser = null;
                document.getElementById('display-user').innerText = "Guest Player";
                document.getElementById('display-user').style.color = "white";
            } else {
                let db = JSON.parse(localStorage.getItem('mm_v24_db') || '{}');
                currentUser = { name: name, data: db[name] };
                document.getElementById('display-user').innerText = name;
                document.getElementById('display-user').style.color = "var(--accent-cyan)";
            }
            closeUserModal();
        }

        function goHome() { if(confirm("Í≤åÏûÑÏùÑ Ï¢ÖÎ£åÌïòÍ≥† ÌôàÏúºÎ°ú ÎèåÏïÑÍ∞ÄÏãúÍ≤†ÏäµÎãàÍπå?")) location.reload(); }

        // Í≤åÏûÑ Î°úÏßÅ
        function startGame() {
            document.getElementById('screen-start').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            history = []; qNum = 1;
            nextQ();
        }

        function nextQ() {
            if(qNum > totalQ) { finish(); return; }
            
            isProcessing = false;
            document.getElementById('q-curr').innerText = qNum;
            document.getElementById('msg-box').innerText = '';
            
            genProb();
            
            clearInterval(timerInt);
            document.getElementById('timer').innerText = "0.0";
            startTime = Date.now();
            timerInt = setInterval(()=>{ document.getElementById('timer').innerText = ((Date.now()-startTime)/1000).toFixed(1); }, 100);
        }

        function genProb() {
            const sInputArea = document.getElementById('speed-input-container');
            
            if(mode === 'speed') {
                if(speedOpType === 'random') {
                    const ops = ['+','-','*','/'];
                    op = ops[Math.floor(Math.random()*ops.length)];
                } else { op = speedOpType; }

                let min=1, max=9;
                if(difficulty === 2) { min=10; max=99; }
                if(difficulty === 3) { min=10; max=99; }
                if(difficulty === 4) { min=100; max=999; }

                if(op === '+') { 
                    num1 = rand(min, max); 
                    num2 = rand(min, max); 
                    ans = num1 + num2; 
                } 
                else if(op === '-') { 
                    num1 = rand(min, max); 
                    num2 = rand(min, max); 
                    if(num1 < num2) [num1, num2] = [num2, num1]; 
                    ans = num1 - num2; 
                } 
                else if(op === '*') { 
                    if(difficulty === 1) { num1 = rand(2,9); num2 = rand(2,9); }
                    else if(difficulty === 2) { num1 = rand(10,99); num2 = rand(2,9); }
                    else if(difficulty === 3) { num1 = rand(10,99); num2 = rand(10,99); }
                    else { num1 = rand(100,999); num2 = rand(2,9); }
                    ans = num1 * num2; 
                } 
                else { 
                    num2 = rand(2, 9); 
                    ans = rand(2, difficulty*5); 
                    num1 = ans * num2; 
                }
            } else {
                op = '*'; 
                num1 = rand(100, 999); 
                num2 = rand(2, 9); 
                ans = num1 * num2;
            }
            renderUI();
        }

        function rand(min, max) { return Math.floor(Math.random()*(max-min+1))+min; }

        function renderUI() {
            const pArea = document.getElementById('problem-area');
            const bArea = document.getElementById('bottom-area');
            const sInputArea = document.getElementById('speed-input-container');
            pArea.innerHTML = ''; bArea.innerHTML = ''; sInputArea.innerHTML = ''; sInputArea.classList.add('hidden');

            if(mode === 'speed') {
                let sym = op==='*'?'√ó':(op==='/'?'√∑':op);
                pArea.innerHTML = `<div class="speed-text">${num1}<span class="speed-op">${sym}</span>${num2}</div>`;
                sInputArea.classList.remove('hidden');
                sInputArea.innerHTML = `<input id="ans-speed" class="final-input active" style="max-width:200px; height:60px; font-size:2.5rem;" readonly onclick="focusId('ans-speed')">`;
                activeId = 'ans-speed';
            } else {
                const s1 = String(num1);
                let html = `<div class="v-grid">`;
                html += `<div></div><div></div><div><div class="carry-circle" id="c1" onclick="focusId('c1')"></div></div><div><div class="carry-circle" id="c2" onclick="focusId('c2')"></div></div><div></div>`;
                html += `<div></div><div></div><div class="v-cell">${s1[0]}</div><div class="v-cell">${s1[1]}</div><div class="v-cell">${s1[2]}</div>`;
                html += `<div class="v-cell" style="color:#ff3b30">√ó</div><div></div><div></div><div></div><div class="v-cell">${num2}</div>`;
                html += `<div class="v-line"></div>`;
                for(let i=0; i<5; i++) { html += `<div class="final-cell-wrapper"><input id="ans-${i}" class="final-input" readonly onclick="focusId('ans-${i}')"></div>`; }
                html += `</div>`;
                pArea.innerHTML = html;

                let stepHtml = `<div class="step-container">`;
                const digits = s1.split('').reverse();
                digits.forEach((d, i) => {
                    stepHtml += `<div class="step-row"><span style="color:var(--accent-cyan); font-weight:bold;">${d}</span> √ó ${num2} = <input id="step-${i}" class="step-input" readonly onclick="focusId('step-${i}')"></div>`;
                });
                stepHtml += `</div>`;
                bArea.innerHTML = stepHtml;
                focusId('step-0');
            }
        }

        function focusId(id) {
            if(activeId) { 
                const prev = document.getElementById(activeId); 
                if(prev) { 
                    prev.classList.remove('active'); 
                    if(prev.classList.contains('carry-circle')) prev.style.background = 'transparent'; 
                }
            }
            activeId = id; 
            const curr = document.getElementById(id); 
            if(curr) { 
                curr.classList.add('active'); 
                if(curr.classList.contains('carry-circle')) curr.style.background = 'rgba(255,255,255,0.2)'; 
            }
        }

        function inputKey(n) {
            if(!activeId || isProcessing) return;
            const el = document.getElementById(activeId);
            if(activeId === 'ans-speed' || activeId.startsWith('step')) { 
                if(el.value.length < 8) el.value += n; 
            } 
            else if(activeId.startsWith('c')) { 
                el.innerText = n; 
            } 
            else { 
                el.value = n; 
            }
        }

        function delKey() {
            if(!activeId || isProcessing) return;
            const el = document.getElementById(activeId);
            if(activeId.startsWith('c')) el.innerText = ''; 
            else if(activeId === 'ans-speed' || activeId.startsWith('step')) el.value = el.value.slice(0, -1);
            else el.value = '';
        }

        function submitAns() {
            if(!activeId || isProcessing) return;
            
            if(activeId.startsWith('step')) {
                const idx = parseInt(activeId.split('-')[1]);
                const next = `step-${idx+1}`;
                if(document.getElementById(next)) focusId(next); else focusId('ans-4');
                return;
            }
            
            let uVal;
            if(mode === 'speed') { 
                uVal = parseInt(document.getElementById('ans-speed').value); 
            } 
            else { 
                let s = ""; 
                for(let i=0; i<5; i++) { 
                    const e = document.getElementById(`ans-${i}`); 
                    if(e) s += e.value; 
                } 
                uVal = parseInt(s); 
            }

            if(isNaN(uVal)) return;

            isProcessing = true;
            clearInterval(timerInt);

            const elapsedTime = (Date.now() - startTime) / 1000;
            const ok = (uVal === ans);
            history.push({ 
                q: `${num1} ${op} ${num2}`, 
                a: ans, 
                u: uVal, 
                ok: ok,
                time: elapsedTime
            });

            if(ok) { 
                document.getElementById('msg-box').innerText = "Ï†ïÎãµ!";
                document.getElementById('msg-box').style.color = "#00ff88"; 
                setTimeout(()=>{ qNum++; nextQ(); }, 600); 
            } 
            else { 
                document.getElementById('msg-box').innerText = `ÌãÄÎ†∏Ïñ¥Ïöî! Ï†ïÎãµ: ${ans}`;
                document.getElementById('msg-box').style.color = "#ff3b30"; 
                setTimeout(()=>{ qNum++; nextQ(); }, 1200); 
            }
        }

        function finish() {
            clearInterval(timerInt);
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-result').classList.remove('hidden');
            
            const correct = history.filter(h=>h.ok).length;
            document.getElementById('final-score').innerText = correct * 10;
            
            const tbody = document.getElementById('res-tbody'); 
            tbody.innerHTML = '';
            
            history.forEach((h, i) => {
                let qStr = h.q.replace('*','√ó').replace('/','√∑');
                tbody.innerHTML += `
                    <tr>
                        <td>${i+1}</td>
                        <td>${qStr}</td>
                        <td>${h.ok ? `<span class="correct-ans">${h.a}</span>` : `<span class="wrong-ans">${h.u}</span> / ${h.a}`}</td>
                        <td style="color:#888">${h.time.toFixed(1)}s</td>
                        <td style="color:${h.ok?'var(--accent-cyan)':'#ff3b30'}">${h.ok?'O':'X'}</td>
                    </tr>`;
            });

            const totalTime = history.reduce((sum, h) => sum + h.time, 0);
            const avgTime = (totalTime / history.length).toFixed(1);

            if(currentUser) {
                let db = JSON.parse(localStorage.getItem('mm_v24_db') || '{}');
                if(!db[currentUser.name]) db[currentUser.name] = { games: 0, time: 0 };
                
                db[currentUser.name].games++;
                db[currentUser.name].time += totalTime;
                
                localStorage.setItem('mm_v24_db', JSON.stringify(db));
                
                const userAvgTime = (db[currentUser.name].time / db[currentUser.name].games / 10).toFixed(1);
                document.getElementById('total-games').innerText = db[currentUser.name].games;
                document.getElementById('avg-time').innerText = userAvgTime;
            } else {
                document.getElementById('total-games').innerText = "1 (Guest)";
                document.getElementById('avg-time').innerText = avgTime;
            }
        }

        // ÌÇ§Î≥¥Îìú ÏßÄÏõê
        document.addEventListener('keydown', (e) => {
            const gameScreen = document.getElementById('screen-game');
            if(gameScreen.classList.contains('hidden')) return;
            
            if(e.key >= '0' && e.key <= '9') {
                e.preventDefault();
                inputKey(parseInt(e.key));
            }
            else if(e.key === 'Enter') {
                e.preventDefault();
                submitAns();
            }
            else if(e.key === 'Backspace' || e.key === 'Delete') {
                e.preventDefault();
                delKey();
            }
        });

        // Enter ÌÇ§Î°ú ÏÉà ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä
        document.getElementById('inp-name').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                e.preventDefault();
                registerNewUser();
            }
        });
    </script>
</body>
</html>
