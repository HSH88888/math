<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="color-scheme" content="dark">
    <title>Math Master V25 - Abacus Integration</title>
    <style>
        /* [í…Œë§ˆ: Deep Purple & Cyan] */
        :root {
            color-scheme: dark;
            --bg-color: #2b2742; 
            --card-bg: #1e1b33;
            --accent-cyan: #00f2fe; 
            --accent-purple: #5e5ce6;
            --accent-orange: #ff9500;
            --text-white: #ffffff;
            --text-gray: #a0a0b0;
            --input-bg: rgba(255, 255, 255, 0.1);
            --border-radius: 16px;
            --font-main: 'Segoe UI', Roboto, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html { height: 100%; overflow: hidden; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-white);
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            -webkit-text-size-adjust: 100%;
        }

        .app-container {
            width: 100%; max-width: 480px; height: 100%; max-height: 900px;
            background: linear-gradient(180deg, #363255 0%, #1e1b33 100%);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; padding: 20px;
            position: relative; overflow-y: auto; overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        .app-container::-webkit-scrollbar { display: none; }
        
        @media (max-width: 600px), (max-height: 800px) {
            .app-container { max-width: 100%; max-height: 100%; border-radius: 0; padding: 15px 15px 25px 15px; }
        }

        /* [ì‹œì‘ í™”ë©´] */
        .title-area { text-align: center; margin-top: 20px; margin-bottom: 20px; flex-shrink: 0; }
        .main-title { 
            font-size: 2.5rem; font-weight: 900; color: white; 
            text-shadow: 0 0 20px rgba(0, 242, 254, 0.8); margin: 0; 
        }
        .sub-title { color: var(--text-gray); margin-top: 5px; font-size: 0.9rem; }
        
        .user-bar { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink: 0; }
        .user-name { font-weight: bold; color: var(--accent-cyan); font-size: 1.1rem; }
        .btn-change { background: transparent; border: 1px solid var(--accent-cyan); color: var(--accent-cyan); border-radius: 20px; padding: 5px 15px; font-size: 0.8rem; cursor: pointer; }

        .mode-box { background: rgba(0,0,0,0.25); border-radius: 16px; padding: 15px; margin-bottom: 15px; flex-shrink: 0; }
        .box-title { color: var(--accent-cyan); font-weight: 800; margin-bottom: 12px; font-size: 0.9rem; letter-spacing: 1px; text-transform: uppercase; }
        
        .radio-option { display: flex; align-items: flex-start; margin-bottom: 10px; cursor: pointer; }
        .radio-option input { margin-top: 5px; margin-right: 15px; accent-color: var(--accent-cyan); transform: scale(1.3); }
        .opt-title { font-size: 1.1rem; font-weight: bold; color: white; margin-bottom: 4px; }
        .opt-desc { font-size: 0.9rem; color: var(--text-gray); line-height: 1.4; }
        
        /* ì—°ì‚° ë²„íŠ¼ */
        .op-select { margin-left: 35px; margin-bottom: 15px; display: flex; gap: 8px; }
        .op-btn { 
            width: 40px; height: 40px; 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
            color: white; border-radius: 8px; font-size: 1.2rem; font-weight: bold; cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
        }
        .op-btn.selected { background: var(--accent-cyan); color: #000; border-color: var(--accent-cyan); }

        /* ë‚œì´ë„ ì„ íƒ */
        .level-select { margin-left: 35px; margin-bottom: 20px; display: flex; gap: 8px; }
        .lvl-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 5px 12px; border-radius: 8px; font-size: 0.85rem; cursor: pointer; }
        .lvl-btn.selected { background: var(--accent-purple); color: white; border-color: var(--accent-purple); font-weight: bold; }
        .level-select.word-mode .lvl-btn.selected { background: var(--accent-orange); border-color: var(--accent-orange); color: black; }

        .btn-start { width: 100%; padding: 18px; border-radius: 30px; background: var(--accent-cyan); color: #000; font-size: 1.3rem; font-weight: 900; border: none; cursor: pointer; box-shadow: 0 0 20px rgba(0, 242, 254, 0.4); margin-top: 20px; margin-bottom: 10px; }
        .btn-feedback { width: 100%; padding: 12px; border-radius: 20px; background: rgba(94,92,230,0.2); border: 1px solid var(--accent-purple); color: var(--accent-purple); font-size: 0.9rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-feedback:hover { background: rgba(94,92,230,0.3); }

        /* [ê²Œì„ í™”ë©´] */
        .game-header { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; margin-bottom: 20px; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .btn-home { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; padding: 0; margin-right: 5px; }
        .q-count { color: white; font-weight: bold; font-size: 1.2rem; }
        .timer { color: var(--accent-cyan); font-weight: bold; font-size: 1.5rem; font-family: monospace; }

        /* ë¬¸ì œ ì¹´ë“œ */
        .problem-card { 
            background: #231f38; border-radius: 20px; padding: 20px; min-height: 180px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 15px; position: relative; 
        }
        .speed-text { font-size: 3.5rem; font-weight: bold; margin-bottom: 5px; line-height: 1; }
        .speed-op { color: #ff3b30; margin: 0 15px; }
        
        .word-prob-text { font-size: 1.3rem; line-height: 1.6; text-align: center; color: white; word-break: keep-all; margin-bottom: 20px; }
        @media (max-width: 600px) { .word-prob-text { font-size: 1.1rem; } }

        .speed-input-area { width: 100%; display: flex; justify-content: center; margin-top: 10px; } 

        /* ì„¸ë¡œì‹(ë‹¨ê³„ë³„) ìŠ¤íƒ€ì¼ */
        .step-container { background: rgba(255,255,255,0.05); border-radius: 20px; padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 10px; }
        .step-row { display: flex; align-items: center; gap: 10px; font-size: 1.1rem; color: #ccc; }
        .step-input { width: 80px; height: 40px; background: rgba(255,255,255,0.1); border: 2px solid #555; border-radius: 10px; text-align: center; color: white; font-size: 1.2rem; font-weight: bold; outline: none; }
        .step-input.active { border-color: var(--accent-cyan); box-shadow: 0 0 10px rgba(0, 242, 254, 0.3); }

        .v-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0; width: 100%; max-width: 300px; }
        .v-cell { height: 50px; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; font-weight: bold; color: white; }
        .v-line { grid-column: 1/-1; height: 2px; background: #666; margin: 5px 0; }
        .carry-circle { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #666; color: #ff3b30; display:flex; align-items:center; justify-content:center; font-size:1rem; margin:auto;}

        .final-cell-wrapper { padding: 4px; }
        .final-input { width: 100%; height: 55px; background: rgba(255,255,255,0.1); border: 2px solid #555; border-radius: 12px; color: white; text-align: center; font-size: 1.8rem; font-weight: bold; }
        .final-input.active { border-color: var(--accent-cyan); }
        .final-input::placeholder { color: rgba(255,255,255,0.2); font-size: 1rem; font-weight: normal; }

        /* í‚¤íŒ¨ë“œ ì˜ì—­ */
        .numpad-container { margin-top: 15px; width: 100%; margin-bottom: 15px; flex-shrink: 0; }
        .numpad { display: grid; grid-template-columns: 1.3fr repeat(6, 1fr); gap: 5px; width: 100%; }
        .key { height: 50px; background: rgba(255,255,255,0.1); border: none; border-radius: 10px; color: white; font-size: 1.3rem; font-weight: bold; cursor: pointer; touch-action: manipulation; padding: 0; }
        .key:active { background: rgba(255,255,255,0.3); transform: scale(0.95); }
        .key-ent { background: var(--accent-cyan); color: #000; }
        .key-del { color: #ff3b30; }

        .mode-btn { height: 50px; background: rgba(255,255,255,0.05); border: 1px solid #555; border-radius: 10px; color: #777; font-size: 0.8rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1.2; text-align: center; transition: all 0.2s; padding: 0 4px; }
        .mode-btn.active { border-color: var(--accent-cyan); color: var(--accent-cyan); background: rgba(0, 242, 254, 0.1); box-shadow: 0 0 10px rgba(0, 242, 254, 0.1); }
        @media (max-width: 400px) { .numpad { gap: 3px; } .key { font-size: 1.1rem; border-radius: 8px; } .mode-btn { font-size: 0.75rem; border-radius: 8px; } }

        /* ë„êµ¬ ì»¨í…Œì´ë„ˆ (ê·¸ë¦¼íŒ & ì£¼íŒ íƒ­ í†µí•©) */
        .tool-container {
            background: rgba(0,0,0,0.2); border-radius: 16px; padding: 10px;
            margin-top: 10px; margin-bottom: 20px; display: block; flex-shrink: 0; /* í•­ìƒ í‘œì‹œ */
            transition: all 0.3s ease;
        }
        
        .tool-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        /* íƒ­ ìŠ¤ìœ„ì¹˜ ìŠ¤íƒ€ì¼ */
        .tool-tabs { display: flex; gap: 15px; }
        .tab-item { 
            color: #777; font-size: 0.95rem; font-weight: bold; cursor: pointer; 
            padding-bottom: 2px; border-bottom: 2px solid transparent; transition: all 0.2s;
        }
        .tab-item.active { color: var(--accent-cyan); border-bottom-color: var(--accent-cyan); }
        .tab-item:hover { color: white; }

        .tool-controls { display: flex; gap: 8px; }
        .tool-btn { padding: 5px 12px; border-radius: 8px; border: none; background: rgba(255,255,255,0.1); color: white; font-size: 0.8rem; cursor: pointer; font-weight: bold; }
        .tool-btn:active { transform: scale(0.95); }

        /* 1. ê·¸ë¦¼íŒ */
        .sketch-canvas { width: 100%; height: 200px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 2px solid rgba(255,255,255,0.1); cursor: crosshair; touch-action: none; display: none; } /* ê¸°ë³¸ ìˆ¨ê¹€ */
        .color-palette { display: none; gap: 8px; margin-top: 8px; justify-content: center; } /* ê¸°ë³¸ ìˆ¨ê¹€ */
        .color-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); cursor: pointer; }
        .color-btn.active { border-color: white; box-shadow: 0 0 10px rgba(255,255,255,0.5); }

        /* 2. ì£¼íŒ ê³µí†µ CSS */
        .abacus-box {
            width: 100%; height: 220px;
            background: #2a2a2a; 
            border-radius: 12px;
            border: 6px solid #666; 
            box-shadow: inset 0 0 15px rgba(0,0,0,0.8), 0 0 10px rgba(255,255,255,0.1);
            padding: 5px; 
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            position: relative; 
            overflow: hidden;
        }
        
        .abacus-inner {
            display: flex; justify-content: space-evenly; 
            height: 100%; width: 100%; align-items: center; 
            position: relative; z-index: 1;
        }

        /* í°ìƒ‰ ê°€ë¡œëŒ€ (Beam) */
        .beam-full {
            position: absolute;
            top: 60px;
            left: 0; right: 0;
            height: 10px;
            background: #eee;
            border-top: 1px solid #ccc;
            border-bottom: 1px solid #999;
            z-index: 10; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* ê¸°ë‘¥ (Rod) */
        .rod {
            width: 6px; 
            height: 100%;
            background: #e0d0b0; /* ìƒì•„ìƒ‰ */
            border-radius: 3px;
            position: relative; 
            display: flex; flex-direction: column; align-items: center;
            box-shadow: inset 1px 0 2px rgba(0,0,0,0.2);
            z-index: 15; /* ê°€ë¡œëŒ€ ìœ„ */
        }

        /* ê°€ë¡œëŒ€ ìœ„ì˜ ì  (Dot) */
        .marker-dot {
            width: 5px; height: 5px;
            background: #000; /* ê²€ì€ìƒ‰ ì  */
            border-radius: 50%;
            position: absolute;
            top: 65px; /* ê°€ë¡œëŒ€ ì¤‘ì•™ */
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 16; /* ê¸°ë‘¥ë³´ë‹¤ ìœ„ */
            box-shadow: 0 0 1px rgba(255,255,255,0.5);
        }

        /* ì£¼íŒì•Œ (Bead) ê³µí†µ */
        .bead {
            width: 44px; height: 26px;
            border-radius: 50%;
            transform: scaleX(1.05);
            position: absolute;
            transition: top 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer; 
            z-index: 20; /* ê°€ì¥ ìœ„ */
            box-shadow: 0 0 2px rgba(255,255,255,0.2), 2px 2px 5px rgba(0,0,0,0.5);
        }
        
        /* ì£¼íŒ1 ì „ìš© ìŠ¤íƒ€ì¼ (ê¸°ë³¸ ì˜¤ë Œì§€/ê²€ì •) */
        #abacus-box1 .bead:not(.bead-point) {
            background: linear-gradient(to bottom, #f39c12 0%, #d35400 100%);
        }
        #abacus-box1 .bead-point {
            background: linear-gradient(to bottom, #555 0%, #111 100%);
            box-shadow: 0 0 2px rgba(255,255,255,0.3), 2px 2px 5px rgba(0,0,0,0.5);
        }

        /* ì£¼íŒì•Œ ìœ„ì¹˜ ì¡°ì • */
        .bead-heaven { top: 8px; }
        .bead-heaven.active { top: 32px; }
        .bead-earth-1 { top: 85px; }
        .bead-earth-2 { top: 112px; } 
        .bead-earth-3 { top: 139px; }
        .bead-earth-4 { top: 166px; }
        .bead-earth-1.active { top: 72px; }
        .bead-earth-2.active { top: 99px; }
        .bead-earth-3.active { top: 126px; }
        .bead-earth-4.active { top: 153px; }

        /* í™”ë©´ í‘œì‹œ ì œì–´ëŠ” JSì—ì„œ ì²˜ë¦¬ */

        /* ì •ë‹µ ë©”ì‹œì§€ ë° ê²°ê³¼ í™”ë©´ */
        .msg-box { height: 30px; text-align: center; font-size: 2rem; font-weight: bold; margin-bottom: 10px; min-height: 40px;}
        .result-screen { display: none; text-align: center; }
        .score-big { font-size: 3rem; color: var(--accent-cyan); font-weight: bold; margin: 15px 0; text-shadow: 0 0 20px var(--accent-cyan); }
        .res-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; text-align: left; }
        .res-table th { color: #888; padding: 8px 4px; border-bottom: 1px solid #444; font-size: 0.7rem; }
        .res-table td { padding: 8px 4px; border-bottom: 1px solid #333; }
        .wrong-ans { color: #ff3b30; font-weight: bold; text-decoration: line-through; margin-right: 5px; }
        .correct-ans { color: var(--accent-cyan); font-weight: bold; }

        /* ëª¨ë‹¬ (ì‚¬ìš©ì ê´€ë¦¬ / í”¼ë“œë°±) */
        .hidden { display: none !important; }
        .modal { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:100; }
        .modal-box { background: #2b2742; padding: 20px; border-radius: 16px; width: 80%; }
        
        .user-list { margin: 15px 0; max-height: 200px; overflow-y: auto; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; }
        .user-item.active { border-color: var(--accent-cyan); background: rgba(0, 242, 254, 0.1); }
        .user-item:active { transform: scale(0.98); }
        .del-user-btn { color: #ff3b30; padding: 5px 10px; border: none; background: transparent; font-size: 1.2rem; cursor: pointer; }

        .new-user-form { display: flex; gap: 8px; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        .modal-input { flex: 1; padding: 12px; border-radius: 10px; border: none; background: rgba(255,255,255,0.1); color: white; font-size: 1rem; }
        .modal-textarea { width: 100%; padding: 12px; border-radius: 10px; border: none; background: rgba(255,255,255,0.1); color: white; font-size: 0.9rem; min-height: 100px; resize: vertical; font-family: var(--font-main); }
        .modal-btn { padding: 0 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .btn-add { background: var(--accent-cyan); color: black; }
        .btn-close { width: 100%; padding: 12px; background: #444; color: white; border:none; border-radius:10px; margin-top:10px; font-weight:bold; cursor:pointer;}
        
        .feedback-list { max-height: 300px; overflow-y: auto; margin: 15px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; }
        .feedback-item { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 3px solid var(--accent-cyan); }
        .feedback-author { color: var(--accent-cyan); font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; }
        .feedback-date { color: #888; font-size: 0.75rem; }
        .feedback-body { color: #ddd; font-size: 0.85rem; line-height: 1.4; margin-top: 8px; }
        .loading { text-align: center; color: #888; padding: 20px; }
    </style>
</head>
<body>

    <div class="app-container" id="screen-start">
        <div class="title-area">
            <h1 class="main-title">MATH V25</h1>
            <div class="sub-title">Abacus & Notepad Edition</div>
        </div>

        <div class="user-bar">
            <span class="user-name" id="display-user">Guest Player</span>
            <button class="btn-change" onclick="openUserModal()">ì‚¬ìš©ì ë³€ê²½</button>
        </div>

        <div class="mode-box">
            <div class="box-title">TRAINING MODE</div>
            
            <label class="radio-option">
                <input type="radio" name="mode" value="speed" checked onclick="toggleOptions('speed')">
                <div>
                    <div class="opt-title">âš¡ ìŠ¤í”¼ë“œ ëª¨ë“œ</div>
                    <div class="opt-desc">ì›í•˜ëŠ” ì—°ì‚°ì„ ì„ íƒí•˜ì—¬ ë¹ ë¥´ê²Œ í’‰ë‹ˆë‹¤.</div>
                </div>
            </label>
            
            <div id="speed-ops" class="op-select">
                <div class="op-btn" onclick="setOpType('+')" id="op-plus">ï¼‹</div>
                <div class="op-btn" onclick="setOpType('-')" id="op-minus">ï¼</div>
                <div class="op-btn" onclick="setOpType('*')" id="op-mul">Ã—</div>
                <div class="op-btn" onclick="setOpType('/')" id="op-div">Ã·</div>
                <div class="op-btn selected" onclick="setOpType('random')" id="op-rand">?</div>
            </div>

            <div id="speed-levels" class="level-select">
                <div class="lvl-btn" onclick="setLevel(1)" id="lv1">Lv.1</div>
                <div class="lvl-btn selected" onclick="setLevel(2)" id="lv2">Lv.2</div>
                <div class="lvl-btn" onclick="setLevel(3)" id="lv3">Lv.3</div>
                <div class="lvl-btn" onclick="setLevel(4)" id="lv4">Lv.4</div>
            </div>

            <label class="radio-option" id="label-word">
                <input type="radio" name="mode" value="word" onclick="toggleOptions('word')">
                <div>
                    <div class="opt-title">ğŸ“š ì„œìˆ í˜• ë¬¸ì œ</div>
                    <div class="opt-desc">ë¬¸ì œë¥¼ ì½ê³  ì‹ì„ ì„¸ì›Œ ì •ë‹µì„ êµ¬í•˜ì„¸ìš”.</div>
                </div>
            </label>

            <label class="radio-option">
                <input type="radio" name="mode" value="step" onclick="toggleOptions('step')">
                <div>
                    <div class="opt-title">ğŸ¢ ê³±ì…ˆ ë‹¨ê³„ë³„ í’€ì´</div>
                    <div class="opt-desc">ì„¸ë¡œì‹ ê³±ì…ˆì˜ ì›ë¦¬ë¥¼ ë‹¨ê³„ë³„ë¡œ ìµí™ë‹ˆë‹¤.</div>
                </div>
            </label>
        </div>

        <div style="flex: 1; min-height: 20px;"></div>

        <button class="btn-start" onclick="startGame()">MISSION START</button>
        <button class="btn-feedback" onclick="openFeedbackModal()">ğŸ’¬ í”¼ë“œë°± & ê±´ì˜ì‚¬í•­</button>
    </div>

    <div class="app-container hidden" id="screen-game">
        <div class="game-header">
            <div class="header-left">
                <button class="btn-home" onclick="goHome()">ğŸ </button>
                <div class="q-count">Q <span id="q-curr">1</span> / 10</div>
            </div>
            <div class="timer" id="timer">0.0</div>
        </div>

        <div class="problem-card">
            <div id="problem-area" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
            <div id="speed-input-container" class="speed-input-area hidden"></div>
        </div>

        <div id="bottom-area"></div>

        <div id="msg-box" class="msg-box"></div>

        <div class="numpad-container">
            <div class="numpad">
                <button id="btn-mode-normal" class="mode-btn" onclick="setInputMode('normal')">ìˆœì°¨<br>ì…ë ¥</button>
                <button class="key" onclick="inputKey(1)">1</button>
                <button class="key" onclick="inputKey(2)">2</button>
                <button class="key" onclick="inputKey(3)">3</button>
                <button class="key" onclick="inputKey(4)">4</button>
                <button class="key" onclick="inputKey(5)">5</button>
                <button class="key" onclick="inputKey(6)">6</button>

                <button id="btn-mode-reverse" class="mode-btn active" onclick="setInputMode('reverse')">ì—­ìˆœ<br>ì…ë ¥</button>
                <button class="key" onclick="inputKey(7)">7</button>
                <button class="key" onclick="inputKey(8)">8</button>
                <button class="key" onclick="inputKey(9)">9</button>
                <button class="key" onclick="inputKey(0)">0</button>
                <button class="key key-del" onclick="delKey()">C</button>
                <button class="key key-ent" onclick="submitAns()">OK</button>
            </div>
        </div>

        <div class="tool-container" id="tool-container">
            <div class="tool-header">
                <div class="tool-tabs">
                    <span id="tab-memo" class="tab-item active" onclick="setToolMode('memo')">ğŸ“ ë©”ëª¨ì¥</span>
                    <span id="tab-abacus1" class="tab-item" onclick="setToolMode('abacus1')">ğŸ§® ì£¼íŒ1</span>
                    <span id="tab-abacus2" class="tab-item" onclick="setToolMode('abacus2')">ğŸŒˆ ì£¼íŒ2</span>
                </div>
                <div class="tool-controls">
                    <button class="tool-btn" onclick="clearTool()">ì§€ìš°ê¸°/ì´ˆê¸°í™”</button>
                </div>
            </div>
            
            <canvas id="sketch-canvas" class="sketch-canvas"></canvas>
            <div class="color-palette" id="color-palette">
                <div class="color-btn active" style="background: white;" onclick="setDrawColor('white')"></div>
                <div class="color-btn" style="background: #00f2fe;" onclick="setDrawColor('#00f2fe')"></div>
                <div class="color-btn" style="background: #ff3b30;" onclick="setDrawColor('#ff3b30')"></div>
                <div class="color-btn" style="background: #ffcc00;" onclick="setDrawColor('#ffcc00')"></div>
                <div class="color-btn" style="background: #34c759;" onclick="setDrawColor('#34c759')"></div>
            </div>
            
            <div id="abacus-box1" class="abacus-box">
                </div>
            <div id="abacus-box2" class="abacus-box">
                </div>
        </div>
    </div>

    <div class="app-container hidden" id="screen-result">
        <div style="display:flex; justify-content:space-between; align-items:center; padding:0 10px; margin-top:15px; margin-bottom:10px;">
            <button class="btn-home" onclick="location.reload()" style="font-size:1.8rem;">ğŸ </button>
            <div style="text-align:center;">
                <h1 class="main-title" style="font-size:2rem; margin:0;">REPORT</h1>
                <div style="color:var(--text-gray); font-size:0.85rem; margin-top:5px;" id="result-mode-info"></div>
            </div>
            <button class="btn-home" onclick="restartSameLevel()" style="font-size:1.8rem;">ğŸ”„</button>
        </div>
        <div class="sub-title" id="result-username" style="text-align:center; margin-bottom:10px;">Guest Player</div>
        <div class="score-big" id="final-score">100ì </div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
            <div style="background:rgba(0,242,254,0.1); border:1px solid rgba(0,242,254,0.3); border-radius:12px; padding:12px; text-align:center;">
                <div style="color:#888; font-size:0.75rem; margin-bottom:5px;">ì •ë‹µë¥ </div>
                <div style="color:var(--accent-cyan); font-size:1.5rem; font-weight:bold;" id="accuracy-rate">100%</div>
            </div>
            <div style="background:rgba(94,92,230,0.1); border:1px solid rgba(94,92,230,0.3); border-radius:12px; padding:12px; text-align:center;">
                <div style="color:#888; font-size:0.75rem; margin-bottom:5px;">í‰ê·  ì‹œê°„</div>
                <div style="color:var(--accent-purple); font-size:1.5rem; font-weight:bold;" id="avg-solve-time">0.0ì´ˆ</div>
            </div>
        </div>

        <div style="background:rgba(0,0,0,0.2); border-radius:12px; padding:10px;">
            <table class="res-table">
                <thead><tr><th width="10%">No</th><th width="40%">ë¬¸ì œ</th><th width="30%">ë‚´ë‹µ / ì •ë‹µ</th><th width="20%">ê²°ê³¼</th></tr></thead>
                <tbody id="res-tbody"></tbody>
            </table>
        </div>
    </div>

    <div id="modal-login" class="modal hidden">
        <div class="modal-box">
            <h3 style="color:var(--accent-cyan); margin-bottom:15px;">ì‚¬ìš©ì ì„ íƒ</h3>
            <div id="user-list" class="user-list"></div>
            <div class="new-user-form">
                <input type="text" id="inp-name" class="modal-input" placeholder="ìƒˆ ì‚¬ìš©ì ì´ë¦„">
                <button onclick="registerNewUser()" class="modal-btn btn-add">ì¶”ê°€</button>
            </div>
            <button onclick="closeUserModal()" class="btn-close">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="modal-feedback" class="modal hidden">
        <div class="modal-box" style="max-width:400px;">
            <h3 style="color:var(--accent-cyan); margin-bottom:15px;">ğŸ’¬ í”¼ë“œë°± ê²Œì‹œíŒ</h3>
            <div class="feedback-list" id="feedback-list">
                <div class="loading">í”¼ë“œë°±ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            <div style="margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
                <h4 style="color:var(--accent-purple); margin-bottom:10px; font-size:0.9rem;">ìƒˆ í”¼ë“œë°± ì‘ì„±</h4>
                <input type="text" id="feedback-name" class="modal-input" placeholder="ì´ë¦„ (ì„ íƒ)" style="margin-bottom:8px;">
                <textarea id="feedback-text" class="modal-textarea" placeholder="ì˜ê²¬ì´ë‚˜ ê±´ì˜ì‚¬í•­ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”!"></textarea>
                <button onclick="submitFeedback()" class="modal-btn btn-add" style="width:100%; padding:10px; margin-top:8px;">ì‘ì„±í•˜ê¸°</button>
            </div>
            <button onclick="closeFeedbackModal()" class="btn-close">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // Firebase ì„¤ì •
        const FIREBASE_CONFIG = { projectId: "my-board-1d56c" };

        // ë°ì´í„°
        let mode = 'speed'; 
        let difficulty = 2; 
        let speedOpType = 'random'; 
        let qNum = 1;
        const totalQ = 10;
        let num1, num2, op, ans;
        let activeId = null;
        let history = [];
        let startTime, timerInt;
        let currentUser = null;
        let isProcessing = false;
        let inputDirection = 'reverse';
        let currentWordProblem = "";
        
        // ë„êµ¬ ëª¨ë“œ (memo, abacus1, abacus2)
        let toolMode = 'memo';

        // ê·¸ë¦¼íŒ ë³€ìˆ˜
        let canvas, ctx;
        let isDrawing = false;
        let drawColor = 'white';
        let lastX = 0, lastY = 0;

        // ì„œìˆ í˜• í…œí”Œë¦¿ ë°ì´í„°
        const wordNames = ['ì² ìˆ˜', 'ì˜í¬', 'ë¯¼ìˆ˜', 'ì§€ìˆ˜', 'í˜¸ë‘ì´', 'í† ë¼', 'ë‹¤ëŒì¥', 'ì„ ìƒë‹˜'];
        const wordItems = ['ì‚¬ê³¼', 'ì—°í•„', 'ê³µì±…', 'ì‚¬íƒ•', 'ì§€ìš°ê°œ', 'ë™ì „', 'êµ¬ìŠ¬', 'ì¥ë‚œê°'];
        const wordUnits = ['ê°œ', 'ìë£¨', 'ê¶Œ', 'ê°œ', 'ê°œ', 'ì›', 'ì•Œ', 'ê°œ'];

        // ì´ˆê¸°í™”
        window.onload = function() {
            initCanvas();
            renderAbacus1(); // ì£¼íŒ1 ìƒì„±
            renderAbacus2(); // ì£¼íŒ2 ìƒì„±
            const storedUser = localStorage.getItem('mm_last_user');
            if(storedUser) selectUser(storedUser);
            setToolMode('memo'); // ì´ˆê¸° ëª¨ë“œ ì„¤ì •
        };

        /* --- [ë„êµ¬ ì œì–´: ë©”ëª¨ì¥ <-> ì£¼íŒ1 <-> ì£¼íŒ2] --- */
        function setToolMode(m) {
            toolMode = m;
            const tabMemo = document.getElementById('tab-memo');
            const tabAbacus1 = document.getElementById('tab-abacus1');
            const tabAbacus2 = document.getElementById('tab-abacus2');
            
            const canvas = document.getElementById('sketch-canvas');
            const palette = document.getElementById('color-palette');
            const box1 = document.getElementById('abacus-box1');
            const box2 = document.getElementById('abacus-box2');

            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™” ë° ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€
            tabMemo.classList.remove('active');
            tabAbacus1.classList.remove('active');
            tabAbacus2.classList.remove('active');
            canvas.style.display = 'none';
            palette.style.display = 'none';
            box1.style.display = 'none';
            box2.style.display = 'none';

            // ì„ íƒëœ ëª¨ë“œ í™œì„±í™” ë° ì»¨í…Œì´ë„ˆ í‘œì‹œ
            if (m === 'memo') {
                tabMemo.classList.add('active');
                canvas.style.display = 'block';
                palette.style.display = 'flex';
            } else if (m === 'abacus1') {
                tabAbacus1.classList.add('active');
                box1.style.display = 'block';
            } else if (m === 'abacus2') {
                tabAbacus2.classList.add('active');
                box2.style.display = 'block';
            }
        }

        function clearTool() {
            if (toolMode === 'memo') {
                clearCanvas();
            } else if (toolMode === 'abacus1') {
                resetAbacus('abacus-box1');
            } else if (toolMode === 'abacus2') {
                resetAbacus('abacus-box2');
            }
        }

        /* --- [ì£¼íŒ ë¡œì§] --- */
        // ì£¼íŒ1 ë Œë”ë§ (ê¸°ì¡´ ì˜¤ë Œì§€/ê²€ì •)
        function renderAbacus1() {
            const box = document.getElementById('abacus-box1');
            box.innerHTML = '';
            const inner = document.createElement('div'); inner.className = 'abacus-inner'; box.appendChild(inner);
            const beamFull = document.createElement('div'); beamFull.className = 'beam-full'; inner.appendChild(beamFull);

            for(let i=0; i<7; i++) {
                const rod = document.createElement('div'); rod.className = 'rod';
                const isMarker = (i === 2 || i === 5);
                if (isMarker) { const dot = document.createElement('div'); dot.className = 'marker-dot'; rod.appendChild(dot); }
                
                const hBead = document.createElement('div'); hBead.className = 'bead bead-heaven';
                hBead.onclick = function() { this.classList.toggle('active'); }; rod.appendChild(hBead);

                for(let j=1; j<=4; j++) {
                    const eBead = document.createElement('div');
                    let beadClass = `bead bead-earth-${j}`;
                    if (isMarker && j === 1) beadClass += ' bead-point';
                    eBead.className = beadClass;
                    eBead.onclick = function() { this.classList.toggle('active'); }; rod.appendChild(eBead);
                }
                inner.appendChild(rod);
            }
        }

        // ì£¼íŒ2 ë Œë”ë§ (ì•Œë¡ë‹¬ë¡ ìƒ‰ìƒ)
        function renderAbacus2() {
            const box = document.getElementById('abacus-box2');
            box.innerHTML = '';
            const inner = document.createElement('div'); inner.className = 'abacus-inner'; box.appendChild(inner);
            const beamFull = document.createElement('div'); beamFull.className = 'beam-full'; inner.appendChild(beamFull);

            // ì´ë¯¸ì§€ ìƒ‰ìƒ íŒ¨í„´ ì •ì˜
            const colors = [
                ['#ff9f43', '#e67e22', '#d35400'], // 0: ì£¼í™©
                ['#ff3b30', '#c0392b', '#a93226'], // 1: ë¹¨ê°•
                ['#00f2fe', '#007aff', '#0056b3'], // 2: íŒŒë‘
                ['#ffffff', '#f0f0f0', '#dcdcdc'], // 3: í°ìƒ‰
                ['#ff3b30', '#c0392b', '#a93226'], // 4: ë¹¨ê°•
                ['#ffcc00', '#f1c40f', '#d4ac0d'], // 5: ë…¸ë‘
                ['#34c759', '#2ecc71', '#27ae60']  // 6: ì´ˆë¡
            ];

            for(let i=0; i<7; i++) {
                const rod = document.createElement('div'); rod.className = 'rod';
                
                // ìƒ‰ìƒ ê·¸ë¼ë°ì´ì…˜ ìƒì„±
                const col = colors[i % colors.length];
                const bgStyle = `linear-gradient(to bottom, ${col[0]} 0%, ${col[1]} 40%, ${col[2]} 50%, ${col[0]} 60%, ${col[2]} 100%)`;
                const shadowStyle = `0 0 2px rgba(255,255,255,0.2), 2px 2px 5px rgba(0,0,0,0.3)`;

                const hBead = document.createElement('div'); hBead.className = 'bead bead-heaven';
                hBead.style.background = bgStyle; hBead.style.boxShadow = shadowStyle;
                hBead.onclick = function() { this.classList.toggle('active'); }; rod.appendChild(hBead);

                for(let j=1; j<=4; j++) {
                    const eBead = document.createElement('div');
                    eBead.className = `bead bead-earth-${j}`;
                    eBead.style.background = bgStyle; eBead.style.boxShadow = shadowStyle;
                    eBead.onclick = function() { this.classList.toggle('active'); }; rod.appendChild(eBead);
                }
                inner.appendChild(rod);
            }
        }

        function resetAbacus(boxId) {
            document.querySelectorAll(`#${boxId} .bead`).forEach(b => b.classList.remove('active'));
        }

        /* --- [ê·¸ë¦¼íŒ ë¡œì§] --- */
        function initCanvas() {
            canvas = document.getElementById('sketch-canvas');
            ctx = canvas.getContext('2d');
            const resizeCanvas = () => {
                const parent = canvas.parentElement;
                if(parent) {
                    canvas.width = parent.clientWidth - 20; 
                    canvas.height = 200;
                    ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.lineWidth = 3; ctx.strokeStyle = drawColor;
                }
            };
            window.addEventListener('resize', resizeCanvas);
            // ì´ˆê¸° ë¡œë“œ ì‹œ ìº”ë²„ìŠ¤ê°€ ìˆ¨ê²¨ì ¸ ìˆì–´ í¬ê¸°ê°€ 0ì´ ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ setTimeout ì‚¬ìš©
            setTimeout(resizeCanvas, 100);
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) { isDrawing = true; const rect = canvas.getBoundingClientRect(); lastX = e.clientX - rect.left; lastY = e.clientY - rect.top; }
        function draw(e) { if (!isDrawing) return; const rect = canvas.getBoundingClientRect(); const currentX = e.clientX - rect.left; const currentY = e.clientY - rect.top; ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(currentX, currentY); ctx.stroke(); lastX = currentX; lastY = currentY; }
        function handleTouchStart(e) { e.preventDefault(); const rect = canvas.getBoundingClientRect(); const touch = e.touches[0]; lastX = touch.clientX - rect.left; lastY = touch.clientY - rect.top; isDrawing = true; }
        function handleTouchMove(e) { if (!isDrawing) return; e.preventDefault(); const rect = canvas.getBoundingClientRect(); const touch = e.touches[0]; const currentX = touch.clientX - rect.left; const currentY = touch.clientY - rect.top; ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(currentX, currentY); ctx.stroke(); lastX = currentX; lastY = currentY; }
        function stopDrawing() { isDrawing = false; }
        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
        function setDrawColor(color) { drawColor = color; ctx.strokeStyle = drawColor; document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active')); event.target.classList.add('active'); }

        /* --- [ê²Œì„ UI ë° ë¡œì§] --- */
        function toggleOptions(m) { 
            mode = m; 
            const levelBox = document.getElementById('speed-levels');
            const speedOps = document.getElementById('speed-ops');
            const wordLabel = document.getElementById('label-word');

            speedOps.style.display = (m === 'speed') ? 'flex' : 'none';
            if (m === 'speed' || m === 'word') {
                levelBox.style.display = 'flex';
                if (m === 'speed') { speedOps.after(levelBox); levelBox.classList.remove('word-mode'); } 
                else { wordLabel.after(levelBox); levelBox.classList.add('word-mode'); }
            } else {
                levelBox.style.display = 'none';
            }
        }

        function setLevel(lv) { difficulty = lv; document.querySelectorAll('.lvl-btn').forEach(b => b.classList.remove('selected')); document.getElementById('lv' + lv).classList.add('selected'); }
        function setOpType(type) { speedOpType = type; document.querySelectorAll('.op-btn').forEach(b => b.classList.remove('selected')); let btnId = type === '+' ? 'op-plus' : (type === '-' ? 'op-minus' : (type === '*' ? 'op-mul' : (type === '/' ? 'op-div' : 'op-rand'))); document.getElementById(btnId).classList.add('selected'); }
        function setInputMode(dir) { inputDirection = dir; const normalBtn = document.getElementById('btn-mode-normal'); const reverseBtn = document.getElementById('btn-mode-reverse'); if (dir === 'normal') { normalBtn.classList.add('active'); reverseBtn.classList.remove('active'); } else { normalBtn.classList.remove('active'); reverseBtn.classList.add('active'); } }

        // ì‚¬ìš©ì ê´€ë¦¬ ë¡œì§
        function openUserModal() { renderUserList(); document.getElementById('modal-login').classList.remove('hidden'); }
        function closeUserModal() { document.getElementById('modal-login').classList.add('hidden'); }
        function renderUserList() {
            const list = document.getElementById('user-list'); list.innerHTML = '';
            const db = JSON.parse(localStorage.getItem('mm_v24_db') || '{}');
            const names = Object.keys(db);
            const guestDiv = document.createElement('div');
            guestDiv.className = `user-item ${currentUser === null ? 'active' : ''}`;
            guestDiv.innerHTML = `<span style="font-weight:bold;">Guest Player</span>`;
            guestDiv.onclick = () => selectUser(null);
            list.appendChild(guestDiv);
            names.forEach(name => {
                const div = document.createElement('div');
                div.className = `user-item ${currentUser && currentUser.name === name ? 'active' : ''}`;
                const userData = db[name];
                const avgTime = userData.games > 0 ? (userData.time / userData.games / 10).toFixed(1) : '0.0';
                div.innerHTML = `<span>${name} <span style="font-size:0.8rem; color:#aaa;">(${userData.games}íŒ | ${avgTime}s)</span></span><button class="del-user-btn" onclick="deleteUser('${name}', event)">Ã—</button>`;
                div.onclick = (e) => { if(e.target.tagName === 'BUTTON') return; selectUser(name); };
                list.appendChild(div);
            });
        }
        function registerNewUser() {
            const nm = document.getElementById('inp-name').value.trim();
            if(!nm) return;
            let db = JSON.parse(localStorage.getItem('mm_v24_db') || '{}');
            if(db[nm]) { alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.'); return; }
            db[nm] = { games: 0, time: 0 };
            localStorage.setItem('mm_v24_db', JSON.stringify(db));
            document.getElementById('inp-name').value = '';
            renderUserList();
        }
        function deleteUser(name, e) {
            e.stopPropagation();
            if(!confirm(`'${name}' ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            let db = JSON.parse(localStorage.getItem('mm_v24_db') || '{}');
            delete db[name];
            localStorage.setItem('mm_v24_db', JSON.stringify(db));
            if(currentUser && currentUser.name === name) selectUser(null);
            renderUserList();
        }
        function selectUser(name) {
            if(name === null) {
                currentUser = null;
                document.getElementById('display-user').innerText = "Guest Player";
                document.getElementById('display-user').style.color = "white";
                localStorage.removeItem('mm_last_user');
            } else {
                let db = JSON.parse(localStorage.getItem('mm_v24_db') || '{}');
                currentUser = { name: name, data: db[name] };
                document.getElementById('display-user').innerText = name;
                document.getElementById('display-user').style.color = "var(--accent-cyan)";
                localStorage.setItem('mm_last_user', name);
            }
            closeUserModal();
        }

        // Firebase í”¼ë“œë°± ë¡œì§
        function openFeedbackModal() { document.getElementById('modal-feedback').classList.remove('hidden'); loadFeedbacks(); }
        function closeFeedbackModal() { document.getElementById('modal-feedback').classList.add('hidden'); }
        async function loadFeedbacks() {
            const list = document.getElementById('feedback-list');
            list.innerHTML = '<div class="loading">í”¼ë“œë°±ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            try {
                const url = `https://firestore.googleapis.com/v1/projects/${FIREBASE_CONFIG.projectId}/databases/(default)/documents/feedbacks?orderBy=createdAt desc&pageSize=20`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed');
                const data = await response.json();
                if (!data.documents || data.documents.length === 0) { list.innerHTML = '<div class="loading">í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
                list.innerHTML = '';
                data.documents.forEach(doc => {
                    const author = doc.fields.author?.stringValue || 'ìµëª…';
                    const content = doc.fields.content?.stringValue || '';
                    const date = new Date(doc.fields.createdAt?.timestampValue);
                    const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
                    const div = document.createElement('div');
                    div.className = 'feedback-item';
                    div.innerHTML = `<div style="display:flex; justify-content:space-between;"><span class="feedback-author">${author}</span><span class="feedback-date">${dateStr}</span></div><div class="feedback-body">${content.replace(/\n/g, '<br>')}</div>`;
                    list.appendChild(div);
                });
            } catch (error) { list.innerHTML = '<div class="loading" style="color:#ff3b30;">í”¼ë“œë°± ë¡œë“œ ì‹¤íŒ¨</div>'; }
        }
        async function submitFeedback() {
            const name = document.getElementById('feedback-name').value.trim() || 'ìµëª…';
            const text = document.getElementById('feedback-text').value.trim();
            if (!text) { alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
            try {
                const url = `https://firestore.googleapis.com/v1/projects/${FIREBASE_CONFIG.projectId}/databases/(default)/documents/feedbacks`;
                await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ fields: { author: { stringValue: name }, content: { stringValue: text }, createdAt: { timestampValue: new Date().toISOString() } } }) });
                alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                document.getElementById('feedback-text').value = '';
                loadFeedbacks();
            } catch (error) { alert('ë“±ë¡ ì‹¤íŒ¨'); }
        }

        // ê²Œì„ ì œì–´
        function goHome() { if(confirm("ê²Œì„ì„ ì¢…ë£Œí•˜ê³  í™ˆìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) location.reload(); }
        function restartSameLevel() {
            document.getElementById('screen-result').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            history = []; qNum = 1; nextQ();
        }

        function startGame() {
            document.getElementById('screen-start').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            // ê²Œì„ ì‹œì‘ ì‹œ ë„êµ¬ ì»¨í…Œì´ë„ˆëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í‘œì‹œë˜ê³ , setToolMode('memo')ì— ì˜í•´ ë©”ëª¨ì¥ì´ ì„ íƒëœ ìƒíƒœë¡œ ì‹œì‘ë¨
            
            setTimeout(() => {
                const canvas = document.getElementById('sketch-canvas');
                canvas.width = canvas.parentElement.clientWidth - 20;
                canvas.height = 200;
                ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.lineWidth = 3; ctx.strokeStyle = drawColor;
            }, 100);

            nextQ();
        }

        function nextQ() {
            if(qNum > totalQ) { finish(); return; }
            isProcessing = false;
            document.getElementById('q-curr').innerText = qNum;
            document.getElementById('msg-box').innerText = '';
            
            clearTool();
            
            if (mode === 'word') genWordProb();
            else if (mode === 'step') genStepProb();
            else genProb();
            
            clearInterval(timerInt);
            document.getElementById('timer').innerText = "0.0";
            startTime = Date.now();
            timerInt = setInterval(()=>{ document.getElementById('timer').innerText = ((Date.now()-startTime)/1000).toFixed(1); }, 100);
        }

        function rand(min, max) { return Math.floor(Math.random()*(max-min+1))+min; }

        function genWordProb() {
            const ops = ['+','-','*','/'];
            let chosenOp;
            if (difficulty <= 2) chosenOp = Math.random() < 0.8 ? ops[Math.floor(Math.random()*2)] : ops[2];
            else chosenOp = ops[Math.floor(Math.random()*ops.length)];

            let min, max;
            if(difficulty === 1) { min=2; max=15; }
            else if(difficulty === 2) { min=10; max=50; }
            else if(difficulty === 3) { min=50; max=500; }
            else { min=500; max=9000; }

            const name1 = wordNames[Math.floor(Math.random() * wordNames.length)];
            const name2 = wordNames[Math.floor(Math.random() * wordNames.length)];
            const item = wordItems[Math.floor(Math.random() * wordItems.length)];
            const unit = wordUnits[0];

            if (chosenOp === '+') {
                num1 = rand(min, max); num2 = rand(min, max); ans = num1 + num2;
                currentWordProblem = `${name1}ëŠ” ${item}ì„ ${num1}${unit} ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ${name2}ê°€ ${item}ì„ ${num2}${unit} ë” ì£¼ì—ˆìŠµë‹ˆë‹¤. ${name1}ê°€ ê°€ì§„ ${item}ì€ ëª¨ë‘ ëª‡ ${unit}ì¸ê°€ìš”?`; op = '+';
            } else if (chosenOp === '-') {
                num1 = rand(min, max); num2 = rand(Math.floor(min/2), num1); ans = num1 - num2;
                currentWordProblem = `${name1}ëŠ” ${item}ì„ ${num1}${unit} ê°€ì§€ê³  ìˆì—ˆìŠµë‹ˆë‹¤. ê·¸ ì¤‘ ${num2}${unit}ë¥¼ ì¹œêµ¬ì—ê²Œ ì£¼ì—ˆìŠµë‹ˆë‹¤. ë‚¨ì€ ${item}ì€ ëª‡ ${unit}ì¸ê°€ìš”?`; op = '-';
            } else if (chosenOp === '*') {
                let m1 = (difficulty===1)?rand(2,9):(difficulty===2?rand(10,20):(difficulty===3?rand(20,99):rand(100,500))); 
                let m2 = (difficulty===4)?rand(10,50):rand(2,9);
                num1 = m1; num2 = m2; ans = num1 * num2;
                currentWordProblem = `${item}ì´ í•œ ìƒìì— ${num1}${unit}ì”© ë“¤ì–´ìˆìŠµë‹ˆë‹¤. ${num2}ìƒìì— ë“¤ì–´ìˆëŠ” ${item}ì€ ëª¨ë‘ ëª‡ ${unit}ì¸ê°€ìš”?`; op = 'Ã—';
            } else {
                let d2, d1;
                if(difficulty===1) { d2=rand(2,5); d1=d2*rand(2,5); }
                else if(difficulty===2) { d2=rand(2,9); d1=d2*rand(5,15); }
                else if(difficulty===3) { d2=rand(5,20); d1=d2*rand(10,50); }
                else { d2=rand(10,99); d1=d2*rand(20,100); }
                num1 = d1; num2 = d2; ans = num1 / num2;
                currentWordProblem = `${item} ${num1}${unit}ë¥¼ ${num2}ëª…ì—ê²Œ ë˜‘ê°™ì´ ë‚˜ëˆ„ì–´ ì£¼ë ¤ê³  í•©ë‹ˆë‹¤. í•œ ëª…ë‹¹ ëª‡ ${unit}ì”© ê°€ì§ˆ ìˆ˜ ìˆë‚˜ìš”?`; op = 'Ã·';
            }
            renderUI();
        }

        function genProb() {
            if(speedOpType === 'random') { const ops = ['+','-','*','/']; op = ops[Math.floor(Math.random()*ops.length)]; } else { op = speedOpType; }
            let min=1, max=9;
            if(difficulty === 2) { min=10; max=99; } if(difficulty === 3) { min=10; max=99; } if(difficulty === 4) { min=100; max=999; }

            if(op === '+') { num1 = rand(min, max); num2 = rand(min, max); ans = num1 + num2; } 
            else if(op === '-') { num1 = rand(min, max); num2 = rand(min, max); if(num1 < num2) [num1, num2] = [num2, num1]; ans = num1 - num2; } 
            else if(op === '*') { num1 = (difficulty===1)?rand(2,9):(difficulty===2?rand(10,99):(difficulty===3?rand(10,99):rand(100,999))); num2 = rand(2,9); ans = num1 * num2; } 
            else { num2 = rand(2, 9); ans = rand(2, difficulty*5); num1 = ans * num2; }
            renderUI();
        }

        // ë‹¨ê³„ë³„ ë¬¸ì œ ìƒì„±
        function genStepProb() {
            op = '*';
            num1 = rand(100, 999);
            num2 = rand(2, 9);
            ans = num1 * num2;
            renderUI();
        }

        function renderUI() {
            const pArea = document.getElementById('problem-area');
            const bArea = document.getElementById('bottom-area');
            const sInputArea = document.getElementById('speed-input-container');
            pArea.innerHTML = ''; bArea.innerHTML = ''; sInputArea.innerHTML = ''; sInputArea.classList.add('hidden');

            if(mode === 'speed') {
                let sym = op==='*'?'Ã—':(op==='/'?'Ã·':op);
                pArea.innerHTML = `<div class="speed-text">${num1}<span class="speed-op">${sym}</span>${num2}</div>`;
                sInputArea.classList.remove('hidden');
                sInputArea.innerHTML = `<input id="ans-speed" class="final-input active" style="max-width:200px; height:60px; font-size:2.5rem;" readonly onclick="focusId('ans-speed')" placeholder="?">`;
                activeId = 'ans-speed';
            } 
            else if (mode === 'word') {
                pArea.innerHTML = `<div class="word-prob-text">${currentWordProblem}</div>`;
                sInputArea.classList.remove('hidden');
                sInputArea.innerHTML = `<input id="ans-speed" class="final-input active" style="max-width:200px; height:60px; font-size:2.5rem;" readonly onclick="focusId('ans-speed')" placeholder="?">`;
                activeId = 'ans-speed';
            }
            else { // Step mode UI
                const s1 = String(num1);
                let html = `<div class="v-grid">`;
                html += `<div></div><div></div><div><div class="carry-circle" id="c1" onclick="focusId('c1')"></div></div><div><div class="carry-circle" id="c2" onclick="focusId('c2')"></div></div><div></div>`;
                html += `<div></div><div></div><div class="v-cell">${s1[0]}</div><div class="v-cell">${s1[1]}</div><div class="v-cell">${s1[2]}</div>`;
                html += `<div class="v-cell" style="color:#ff3b30">Ã—</div><div></div><div></div><div></div><div class="v-cell">${num2}</div>`;
                html += `<div class="v-line"></div>`;
                for(let i=0; i<5; i++) { html += `<div class="final-cell-wrapper"><input id="ans-${i}" class="final-input" readonly onclick="focusId('ans-${i}')"></div>`; }
                html += `</div>`;
                pArea.innerHTML = html;

                let stepHtml = `<div class="step-container">`;
                const digits = s1.split('').reverse();
                digits.forEach((d, i) => {
                    stepHtml += `<div class="step-row"><span style="color:var(--accent-cyan); font-weight:bold;">${d}</span> Ã— ${num2} = <input id="step-${i}" class="step-input" readonly onclick="focusId('step-${i}')"></div>`;
                });
                stepHtml += `</div>`;
                bArea.innerHTML = stepHtml;
                focusId('step-0');
            }
        }

        function focusId(id) {
            if(activeId) { 
                const prev = document.getElementById(activeId); 
                if(prev) { prev.classList.remove('active'); if(prev.classList.contains('carry-circle')) prev.style.background = 'transparent'; }
            }
            activeId = id; 
            const curr = document.getElementById(id); 
            if(curr) { curr.classList.add('active'); if(curr.classList.contains('carry-circle')) curr.style.background = 'rgba(255,255,255,0.2)'; }
        }

        function inputKey(n) {
            if(!activeId || isProcessing) return;
            const el = document.getElementById(activeId);
            
            if(activeId === 'ans-speed' || activeId.startsWith('step')) { 
                if(el.value.length < 8) {
                    el.value = (inputDirection === 'reverse') ? (n + el.value) : (el.value + n);
                }
            } 
            else if(activeId.startsWith('c')) { el.innerText = n; } 
            else { el.value = n; }
        }

        function delKey() {
            if(!activeId || isProcessing) return;
            const el = document.getElementById(activeId);
            if(activeId === 'ans-speed' || activeId.startsWith('step')) {
                el.value = (inputDirection === 'reverse') ? el.value.slice(1) : el.value.slice(0, -1);
            }
            else if(activeId.startsWith('c')) { el.innerText = ''; }
            else { el.value = ''; }
        }

        function submitAns() {
            if(!activeId || isProcessing) return;
            
            if(activeId.startsWith('step')) {
                const idx = parseInt(activeId.split('-')[1]);
                const next = `step-${idx+1}`;
                if(document.getElementById(next)) focusId(next); else focusId('ans-4');
                return;
            }
            
            let uVal;
            if(mode === 'speed' || mode === 'word') { uVal = parseInt(document.getElementById('ans-speed').value); } 
            else { 
                let s = ""; 
                for(let i=0; i<5; i++) { const e = document.getElementById(`ans-${i}`); if(e) s += e.value; } 
                uVal = parseInt(s); 
            }

            if(isNaN(uVal)) return;

            isProcessing = true;
            clearInterval(timerInt);
            const elapsedTime = (Date.now() - startTime) / 1000;
            const ok = (uVal === ans);
            
            let qText = (mode === 'word') ? `${num1} ${op} ${num2} (ì„œìˆ í˜•)` : `${num1} ${op} ${num2}`;
            history.push({ q: qText, a: ans, u: uVal, ok: ok, time: elapsedTime });

            if(ok) { 
                document.getElementById('msg-box').innerText = "ì •ë‹µ!"; document.getElementById('msg-box').style.color = "#00ff88"; 
                setTimeout(()=>{ qNum++; nextQ(); }, 600); 
            } else { 
                document.getElementById('msg-box').innerText = `í‹€ë ¸ì–´ìš”! ì •ë‹µ: ${ans}`; document.getElementById('msg-box').style.color = "#ff3b30"; 
                setTimeout(()=>{ qNum++; nextQ(); }, 1200); 
            }
        }

        function finish() {
            clearInterval(timerInt);
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-result').classList.remove('hidden');
            
            const correct = history.filter(h=>h.ok).length;
            document.getElementById('final-score').innerText = correct * 10 + 'ì ';
            
            const username = currentUser ? currentUser.name : 'Guest Player';
            document.getElementById('result-username').innerText = username;
            document.getElementById('result-mode-info').innerText = `${mode} Mode â€¢ Lv.${difficulty}`;
            
            const totalTime = history.reduce((sum, h) => sum + h.time, 0);
            const avgTime = (totalTime / history.length).toFixed(1);
            const accuracyRate = ((correct / totalQ) * 100).toFixed(0);
            
            document.getElementById('accuracy-rate').innerText = accuracyRate + '%';
            document.getElementById('avg-solve-time').innerText = avgTime + 'ì´ˆ';
            
            const tbody = document.getElementById('res-tbody'); tbody.innerHTML = '';
            history.forEach((h, i) => {
                tbody.innerHTML += `<tr><td>${i+1}</td><td>${h.q.replace('*','Ã—').replace('/','Ã·')}</td><td>${h.ok ? `<span class="correct-ans">${h.a}</span>` : `<span class="wrong-ans">${h.u}</span> / ${h.a}`}</td><td style="color:${h.ok?'var(--accent-cyan)':'#ff3b30'}">${h.ok?'O':'X'}</td></tr>`;
            });

            if(currentUser) {
                let db = JSON.parse(localStorage.getItem('mm_v24_db') || '{}');
                if(!db[currentUser.name]) db[currentUser.name] = { games: 0, time: 0 };
                db[currentUser.name].games++;
                db[currentUser.name].time += totalTime;
                localStorage.setItem('mm_v24_db', JSON.stringify(db));
            }
        }
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
        document.addEventListener('keydown', (e) => {
            if(document.getElementById('screen-game').classList.contains('hidden')) return;
            if(e.key >= '0' && e.key <= '9') { e.preventDefault(); inputKey(parseInt(e.key)); }
            else if(e.key === 'Enter') { e.preventDefault(); submitAns(); }
            else if(e.key === 'Backspace' || e.key === 'Delete') { e.preventDefault(); delKey(); }
        });
        document.getElementById('inp-name').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') { e.preventDefault(); registerNewUser(); }
        });
    </script>
</body>
</html>
